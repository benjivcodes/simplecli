#!/usr/bin/env bash
# Install the SimpleCLI tool

cd $(dirname "${BASH_SOURCE[0]}") || return 1
DIR="$(pwd)"
INSTALLDIR="${HOME}/.simplecli"

function install() {
  clear

  echo -e "Running core install cmds..."
  mkdir -p "${INSTALLDIR}/bin ${INSTALLDIR}/lib"
  rsync -azh "${DIR}/bin/" "${INSTALLDIR}/bin/"
  rsync -azh "${DIR}/lib/" "${INSTALLDIR}/lib/"
  cd "${INSTALLDIR}/bin/" || return 1
  chmod +x ./*

  echo -e "Running pip3 installs..."
  cd "${HOME}" || exit 1
  python3 -m venv "${USER}-env"
  "${HOME}/bva-env/bin/python3" -m pip install --upgrade pip | { grep -v "already satisfied" || :; }
  source "${HOME}/${USER}-env/bin/activate"
  set -o pipefail; pip3 install -r "${DIR}/requirements.txt" | { grep -v "already satisfied" || :; }
  deactivate

  echo -e "\nInstalling BasSH configuration"
  if [ -e "${HOME}/.bash_profile" ] || [ -e "${HOME}/.bashrc" ]
  then
    echo -e "\tBaSH config detected, exiting..."
    echo -e "\tManaul install commmand:"
    echo -e "\tAdd the following to your .bash_profile or .bashrc"
    echo -e "\tsource ${INSTALLDIR}/lib/bash/common"
    echo -e "\tsource ${INSTALLDIR}/lib/bash/1passwd-cli"
  else
    cp "${INSTALLDIR}/lib/bash/bash_profile" "${HOME}/.bash_profile"
  fi

  echo -e "\n\nSimpleCLI core successfully installed"
}

function link_bashy(){
  which -a npm > /dev/null || echo -e "\n!!! npm not found, please install NPM or update your PATH"
  cd "${INSTALLDIR}/lib/bashy" || echo -e "\n!!! bashy not available, please update SimpleCLI"
  echo -e "\nLinking Bashy..."

  if [ -e "${HOME}/.npmrc" ]
  then
    echo -e "\tnpmrc config detected, exiting Bashy setup..."
    echo -e "\tManual install command:"
    echo -e "\tcd ${INSTALLDIR}/lib/bashy && npm link > /dev/null"
  else
    export NPM_PACKAGES="${HOME}/.npm-packages"
    echo "prefix=${HOME}/.npm-packages" > "${HOME}/.npmrc"
    npm link > /dev/null
    echo -e "BASHY successfully installed..."
  fi
}

function install_homebrew(){
  echo -e "\nInstalling homebrew..."
  if [ -e "/usr/local/bin/brew" ]
  then
    echo -e "\tHomebrew install detected, exiting..."
  else
    /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/master/install.sh)"
    xargs brew install < "${INSTALLDIR}/lib//brew_bootstrap_packages" 
  fi
}

reset
echo ""

if [[ ! "$(uname -s)" == "Darwin" ]]
then
  echo -e "\nThis is macOS specific CLI; some things will work fine others won't."
  echo -e "Install will continue but you have been warned... \[._.]/"
  echo -en "\nPress enter key to continue."
  read -rs
  reset
fi

install
link_bashy
install_homebrew

