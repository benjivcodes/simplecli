#!/usr/bin/env bash
# Wrapper for Homebrew on MacOS

function brew_description(){
    echo "Homebrew toolchain for macOS"
}

function brew_help(){
  echo -e "\n usage: $(basename "$0") homebrew <subcommand>"
  echo -e "\n AVAILABLE SUBCOMMANDS:\n"
  echo " bootstrap   install Homebrew with a base set of options and tools"
  echo " fix         attempt to fix anything that has gone wrong"
  echo " remove      remove Homebrew from the system"
  echo " meaint      perform Homebrew maintenance"
  echo " multi       attempt to make Homebrew multiuser"
  echo " help        this message"
	echo ""
}
function brew_maint(){
  # Check if brew is installed and perform maintainance
  command -v brew || exit 1
  brew update
  brew upgrade
  brew cask upgrade
  brew cask outdated | cut -f 1 | xargs brew cask reinstall
  brew doctor
  brew missing
  brew cleanup -s
}
function brew_handle(){
  command="$1"

  case $command in
    bootstrap)
      /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/master/install.sh)"
      xargs brew install < "${CLIHOME}/brew_bootstrap_packages.txt"
      brew cask install android-sdk
      brew cask install android-platform-tools
      brew cask install java
    ;;

    fix)
      pushd +0 . || exit 1
      cd /usr/local || exit 1
      git remote add origin https://github.com/Homebrew/brew.git > /dev/null 2>&1
      git fetch origin > /dev/null 2>&1
      git reset --hard origin/master > /dev/null 2>&1
      brew_maint
      popd || exit 1
    ;;

    remove)
      /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/master/uninstall.sh)"
    ;;

    maint)
      brew_maint
    ;;

    multi)
      echo -e "\nYou will need to add users to the group 'admin'"
      sudo chgrp -R admin $(brew --prefix) $(brew --prefix)/Cellar
      sudo chmod -R g+rwX $(brew --prefix) $(brew --prefix)/Cellar
    ;;

    help)
      brew_help
    ;;

    *)
      brew_help
    ;;
  esac
}
